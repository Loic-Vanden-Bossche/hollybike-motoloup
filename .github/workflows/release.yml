name: Release & Deploy

run-name: >
  Release v${{ inputs.version }}
  ${{ inputs.create-executables && '(production only)' || '' }}
  by @${{ github.actor }}

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (example: v1.2.3)"
        required: true
        type: string
      create-executables:
        description: "Build release executables (APK + on-prem binaries)"
        required: false
        type: boolean
        default: false
      play_changes_not_sent_for_review:
        description: "Set true when Play Console requires changesNotSentForReview"
        required: false
        type: boolean
        default: false

concurrency:
  group: release-${{ inputs.version }}
  cancel-in-progress: false

env:
  CI: true

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  build-frontend-backend:
    name: Frontend + Backend
    uses: ./.github/workflows/backend-frontend.yml
    with:
      version: ${{ inputs.version }}
      create-executables: ${{ inputs.create-executables }}
    secrets:
      SCW_ACCESS_KEY_ID: ${{ secrets.SCW_ACCESS_KEY_ID }}
      SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
      MAPBOX_PUBLIC_ACCESS_TOKEN: ${{ secrets.MAPBOX_PUBLIC_ACCESS_TOKEN }}
      MINIO_USERNAME: ${{ secrets.MINIO_USERNAME }}
      MINIO_PASSWORD: ${{ secrets.MINIO_PASSWORD }}
      DATABASE_USERNAME: ${{ secrets.DATABASE_USERNAME }}
      DATABASE_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
      BACKEND_SECUTIRY_SECRET: ${{ secrets.BACKEND_SECUTIRY_SECRET }}
      KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}

  build-app:
    name: Android App
    uses: ./.github/workflows/app.yml
    with:
      version: ${{ inputs.version }}
      create-executables: ${{ inputs.create-executables }}
      play_changes_not_sent_for_review: ${{ inputs.play_changes_not_sent_for_review }}
    secrets:
      ANDROID_KEYSTORE: ${{ secrets.ANDROID_KEYSTORE }}
      ANDROID_KEY_PROPERTIES: ${{ secrets.ANDROID_KEY_PROPERTIES }}
      PRODUCTION_CREDENTIAL_FILE: ${{ secrets.PRODUCTION_CREDENTIAL_FILE }}
      MAPBOX_DOWNLOADS_TOKEN: ${{ secrets.MAPBOX_DOWNLOADS_TOKEN }}
      MAPBOX_PUBLIC_ACCESS_TOKEN: ${{ secrets.MAPBOX_PUBLIC_ACCESS_TOKEN }}

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs:
      - build-app
      - build-frontend-backend
    if: always() && needs.build-app.result == 'success' && needs.build-frontend-backend.result == 'success'
    permissions:
      contents: write
    env:
      VERSION: ${{ inputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download release artifacts
        if: inputs.create-executables
        uses: actions/download-artifact@v7
        with:
          pattern: HollyBike-${{ env.VERSION }}-*
          merge-multiple: true
          path: .

      - name: Create release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          title="${GITHUB_REPOSITORY#*/}-${VERSION#v}"
          if [[ "${{ inputs.create-executables }}" == "true" ]]; then
            title="$title (production only)"
            gh release create "$VERSION" \
              --repo "$GITHUB_REPOSITORY" \
              --title "$title" \
              --generate-notes \
              "hollybike-Android-${VERSION}.apk" \
              "hollybike-Windows-${VERSION}-x86_64.exe" \
              "hollybike-Linux-${VERSION}-x86_64"
          else
            gh release create "$VERSION" \
              --repo "$GITHUB_REPOSITORY" \
              --title "$title" \
              --generate-notes
          fi
