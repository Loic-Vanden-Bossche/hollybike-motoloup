name: App CI/CD

on:
  workflow_call:
    inputs:
      externall_call:
        description: "Whether this run is triggered from another workflow"
        required: false
        type: boolean
        default: true
      version:
        description: "Release version"
        required: true
        type: string
      create-executables:
        description: "Build APK for release assets"
        required: true
        type: boolean
    secrets:
      ANDROID_KEYSTORE:
        description: "Android keystore (base64)"
        required: true
      ANDROID_KEY_PROPERTIES:
        description: "Android signing properties (base64)"
        required: true
      PRODUCTION_CREDENTIAL_FILE:
        description: "Google Play service account JSON (base64)"
        required: true
      MAPBOX_DOWNLOADS_TOKEN:
        description: "Mapbox downloads token"
        required: true
      MAPBOX_PUBLIC_ACCESS_TOKEN:
        description: "Mapbox public access token"
        required: true
  pull_request:
    branches:
      - main
    paths:
      - "packages/app/**"
      - ".github/workflows/app.yml"

concurrency:
  group: app-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CI: true

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    permissions:
      contents: read
    defaults:
      run:
        working-directory: packages/app
        shell: bash
    env:
      KEYSTORE_PATH: android/upload-keystore.jks
      KEY_PROPS_PATH: android/key.properties

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: corretto
          java-version: "17"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Patch native_qr manifest
        run: sed -i 's/\s*package="team.ion.native_qr"//' /home/runner/.pub-cache/hosted/pub.dev/native_qr-0.0.3/android/src/main/AndroidManifest.xml

      - name: Run tests
        run: flutter test

      - name: Decode Android keystore
        if: inputs.create-executables
        run: echo "${{ secrets.ANDROID_KEYSTORE }}" | base64 --decode > "${{ env.KEYSTORE_PATH }}"

      - name: Install keystore
        if: inputs.create-executables
        run: cp "${{ env.KEYSTORE_PATH }}" android/app/upload-keystore.jks

      - name: Decode Android key properties
        if: inputs.create-executables
        run: echo "${{ secrets.ANDROID_KEY_PROPERTIES }}" | base64 --decode > "${{ env.KEY_PROPS_PATH }}"

      - name: Configure Gradle credentials
        if: inputs.create-executables
        run: |
          mkdir -p ~/.gradle
          echo "MAPBOX_DOWNLOADS_TOKEN=${{ secrets.MAPBOX_DOWNLOADS_TOKEN }}" >> ~/.gradle/gradle.properties

      - name: Build APK
        if: inputs.create-executables
        run: |
          flutter build apk \
            --release \
            --build-name="${{ inputs.version }}" \
            --build-number="$(echo "${{ inputs.version }}" | tr -d .)" \
            --dart-define=PUBLIC_ACCESS_TOKEN="${{ secrets.MAPBOX_PUBLIC_ACCESS_TOKEN }}"

      - name: Rename APK
        if: inputs.create-executables
        run: mv build/app/outputs/flutter-apk/app-release.apk "hollybike-Android-${{ inputs.version }}.apk"

      - name: Upload APK artifact
        if: inputs.create-executables
        uses: actions/upload-artifact@v4
        with:
          name: HollyBike-${{ inputs.version }}-Android
          path: packages/app/hollybike-Android-${{ inputs.version }}.apk
          retention-days: 1
          if-no-files-found: error

  deploy:
    name: Deploy
    if: inputs.externall_call
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
    defaults:
      run:
        working-directory: packages/app
        shell: bash
    env:
      AAB_PATH: packages/app/build/app/outputs/bundle/release/app-release.aab
      KEYSTORE_PATH: android/upload-keystore.jks
      KEY_PROPS_PATH: android/key.properties
      SERVICE_ACCOUNT_PATH: store_credentials.json

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: corretto
          java-version: "17"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Patch native_qr manifest
        run: sed -i 's/\s*package="team.ion.native_qr"//' /home/runner/.pub-cache/hosted/pub.dev/native_qr-0.0.3/android/src/main/AndroidManifest.xml

      - name: Decode Android keystore
        run: echo "${{ secrets.ANDROID_KEYSTORE }}" | base64 --decode > "${{ env.KEYSTORE_PATH }}"

      - name: Install keystore
        run: cp "${{ env.KEYSTORE_PATH }}" android/app/upload-keystore.jks

      - name: Decode Android key properties
        run: echo "${{ secrets.ANDROID_KEY_PROPERTIES }}" | base64 --decode > "${{ env.KEY_PROPS_PATH }}"

      - name: Decode service account file
        run: echo "${{ secrets.PRODUCTION_CREDENTIAL_FILE }}" | base64 --decode > "${{ env.SERVICE_ACCOUNT_PATH }}"

      - name: Configure Gradle credentials
        run: |
          mkdir -p ~/.gradle
          echo "MAPBOX_DOWNLOADS_TOKEN=${{ secrets.MAPBOX_DOWNLOADS_TOKEN }}" >> ~/.gradle/gradle.properties

      - name: Build app bundle
        run: |
          flutter build appbundle \
            --release \
            --build-name="${{ inputs.version }}" \
            --build-number="$(echo "${{ inputs.version }}" | tr -d .)" \
            --dart-define=PUBLIC_ACCESS_TOKEN="${{ secrets.MAPBOX_PUBLIC_ACCESS_TOKEN }}"

      - name: Deploy to Play Store (internal testing)
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJson: packages/app/${{ env.SERVICE_ACCOUNT_PATH }}
          packageName: com.hollybike.hollybike
          releaseFiles: ${{ env.AAB_PATH }}
          track: internal
          status: draft
          changesNotSentForReview: true
